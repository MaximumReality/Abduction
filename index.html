<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maximum Reality ‚Äì Select & Launch</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html, body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; color: white; }
  canvas { display: block; }
  
  #overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 200; overflow-y: auto; padding: 20px; }
  #header-img { width: 300px; height: auto; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,255,255,0.5); }
  
  .char-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; max-width: 500px; }
  .char-btn { background: #222; border: 2px solid #555; border-radius: 15px; padding: 10px; text-align: center; cursor: pointer; transition: 0.2s; }
  .char-btn:hover { border-color: #0ff; background: #333; }
  .char-btn img, .char-btn div { width: 60px; height: 60px; object-fit: contain; margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 40px; }
  .char-btn p { margin: 5px 0 0; font-size: 12px; }

  #controls { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 100; padding: 10px; display: none; }
  button { font-size: 28px; padding: 12px 20px; border-radius: 12px; border: none; background: rgba(255,255,255,0.15); color: #fff; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.3); touch-action: manipulation; width: 75px; height: 65px; }
  
  #stats { position: fixed; top: 10px; right: 20px; text-align: right; z-index: 100; display: none; }
</style>
</head>
<body>

<div id="overlay">
  <img src="abduction.png" id="header-img" alt="Abduction">
  <h2>SELECT CHARACTER</h2>
  <div class="char-grid">
    <div class="char-btn" onclick="selectChar('lori')"><img src="lori.png"><p>Lori</p></div>
    <div class="char-btn" onclick="selectChar('man')"><div>üèÉüèª‚Äç‚ôÇÔ∏è</div><p>Man</p></div>
    <div class="char-btn" onclick="selectChar('wc_man')"><div>üßéüèª‚Äç‚ôÇÔ∏è</div><p>Wheelchair M</p></div>
    <div class="char-btn" onclick="selectChar('woman')"><div>üßçüèº‚Äç‚ôÄÔ∏è</div><p>Woman</p></div>
    <div class="char-btn" onclick="selectChar('wc_woman')"><div>üßéüèΩ‚Äç‚ôÄÔ∏è</div><p>Wheelchair W</p></div>
  </div>
</div>

<div id="stats">
  <div>SCORE: <span id="scoreVal">0</span></div>
  <div id="fuelContainer" style="display:none;">
    FUEL: <div style="width:100px; height:10px; background:#444; display:inline-block;"><div id="fuelBar" style="width:100%; height:100%; background:#0f0;"></div></div>
  </div>
</div>

<canvas id="game"></canvas>

<div id="controls">
  <button id="left">‚¨ÖÔ∏è</button>
  <button id="jump">‚¨ÜÔ∏è</button>
  <button id="right">‚û°Ô∏è</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let gameState = "START"; 
let cameraX = 0;
let spaceDistance = 0; 
let score = 0;
const worldWidth = 6000; 

/* CHARACTER LOGIC */
const characters = {
  lori:     { type: 'png', right: "IMG_2161.png", left: "IMG_2162.png" },
  man:      { type: 'emoji', right: "üèÉüèª‚Äç‚ôÇÔ∏è", left: "üèÉüèª" },
  wc_man:   { type: 'emoji', right: "üë®üèª‚Äçü¶Ω‚Äç‚û°Ô∏è", left: "üë®üèª‚Äçü¶Ω" },
  woman:    { type: 'emoji', right: "üèÉüèº‚Äç‚ôÄÔ∏è‚Äç‚û°Ô∏è", left: "üèÉüèº‚Äç‚ôÄÔ∏è" },
  wc_woman: { type: 'emoji', right: "üë©üèΩ‚Äçü¶Ω‚Äç‚û°Ô∏è", left: "üë©üèΩ‚Äçü¶Ω" }
};
let selectedChar = null;
const imgRight = new Image();
const imgLeft = new Image();

function selectChar(key) {
  selectedChar = characters[key];
  if (selectedChar.type === 'png') {
    imgRight.src = selectedChar.right;
    imgLeft.src = selectedChar.left;
  }
  document.getElementById('overlay').style.display = 'none';
  document.getElementById('controls').style.display = 'flex';
  document.getElementById('stats').style.display = 'block';
  gameState = "EARTH";
}

/* PHYSICS & WORLD */
const ROAD_H = 120; const GRASS_H = 140;
let groundY, treeY;

const player = { x: 300, y: 0, vy: 0, jumping: false, dir: "right", speed: 7, isBeingAbducted: false, collisionTimer: 0, fuel: 100 };
const ufo = { state: "WAITING", x: 0, y: 100, size: 0, targetX: 4465, timer: 0, beamAlpha: 0 };
const stars = Array.from({length: 100}, () => ({ x: Math.random() * worldWidth, y: Math.random() * 400, emoji: "‚≠ê" }));
const buildings = Array.from({length: 12}, (_, i) => ({ x: i * 350, emoji: ["üè¢", "üè¨", "üè≠", "üè®", "üè¶"][i % 5] }));
const trees = Array.from({length: 40}, (_, i) => ({ x: i * 150 }));
const asteroids = Array.from({length: 20}, () => ({ x: Math.random() * worldWidth, y: Math.random() * 600, emoji: "ü™®" }));
const fuelTanks = Array.from({length: 5}, () => ({ x: Math.random() * worldWidth, y: Math.random() * 400, collected: false }));
const farm = [{ emoji: "üè†", x: 4450, y: 0, h: 100 }, { emoji: "üêÑ", x: 4465, y: 0, h: 50, abducted: false }];

function resize() {
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  groundY = canvas.height - ROAD_H - 50; treeY = canvas.height - ROAD_H - GRASS_H;
  player.y = groundY; farm[0].y = treeY + 10; farm[1].y = treeY + 100;
}
window.addEventListener("resize", resize); resize();

let keys = { left: false, right: false, jump: false };
function bind(id, k) {
  const btn = document.getElementById(id);
  btn.onmousedown = btn.ontouchstart = (e) => { e.preventDefault(); keys[k] = true; };
  btn.onmouseup = btn.ontouchend = btn.onmouseleave = (e) => { e.preventDefault(); keys[k] = false; };
}
bind("left", "left"); bind("right", "right"); bind("jump", "jump");

function resetEarth() {
  gameState = "EARTH"; player.isBeingAbducted = false; player.y = groundY; player.fuel = 100;
  spaceDistance = 0; ufo.state = "WAITING"; ufo.timer = 0;
  farm[1].y = treeY + 100; farm[1].abducted = false;
  fuelTanks.forEach(t => t.collected = false);
  document.getElementById('fuelContainer').style.display = 'none';
}

function update() {
  if (gameState === "START") return;
  document.getElementById('scoreVal').innerText = score;

  if (gameState === "EARTH") {
    if (keys.left && !player.isBeingAbducted) { player.x -= player.speed; player.dir = "left"; }
    if (keys.right && !player.isBeingAbducted) { player.x += player.speed; player.dir = "right"; }
    if (player.x < 0) player.x = worldWidth; if (player.x > worldWidth) player.x = 0;

    if (player.isBeingAbducted) {
      player.x += (ufo.x + (ufo.size/2) - player.x - 30) * 0.1;
      player.y -= 3;
      if (player.y < ufo.y + 20) { 
          gameState = "SPACE"; score += 50; 
          document.getElementById('fuelContainer').style.display = 'block';
      }
    } else {
      if (keys.jump && !player.jumping) { player.vy = -18; player.jumping = true; }
      player.vy += 0.8; player.y += player.vy;
      if (player.y > groundY) { player.y = groundY; player.vy = 0; player.jumping = false; }
    }

    ufo.timer++;
    switch (ufo.state) {
      case "WAITING": if (ufo.timer > 300) { ufo.state = "INBOUND"; ufo.x = player.x + 800; ufo.size = 50; } break;
      case "INBOUND": ufo.x -= 7; ufo.size = Math.min(115, ufo.size + 1); if (ufo.x <= ufo.targetX) ufo.state = "ABDUCTING"; break;
      case "ABDUCTING":
        ufo.beamAlpha = Math.min(0.4, ufo.beamAlpha + 0.02);
        if (Math.abs(player.x - (ufo.x + ufo.size/2)) < 65 && !player.jumping) player.isBeingAbducted = true;
        if (!farm[1].abducted) { farm[1].y -= 2; if (farm[1].y < ufo.y + 40) { farm[1].abducted = true; ufo.timer = 0; score += 10; }
        } else if (ufo.timer > 120 && !player.isBeingAbducted) ufo.state = "OUTBOUND";
        break;
      case "OUTBOUND": ufo.beamAlpha = Math.max(0, ufo.beamAlpha - 0.05); ufo.x -= 10; ufo.size -= 1; if (ufo.size <= 0) ufo.state = "WAITING"; break;
    }
  } else {
    // SPACE
    spaceDistance += player.speed;
    if (keys.left) { player.x -= player.speed; player.dir = "left"; }
    if (keys.right) { player.x += player.speed; player.dir = "right"; }
    if (player.x < 0) player.x = worldWidth; if (player.x > worldWidth) player.x = 0;
    if (keys.jump && player.fuel > 0) { player.vy -= 1.0; player.fuel -= 0.5; }
    player.vy += 0.3; player.y += player.vy; player.vy *= 0.96;
    document.getElementById('fuelBar').style.width = player.fuel + '%';

    fuelTanks.forEach(t => {
      if (!t.collected && Math.abs((player.x % worldWidth) - t.x) < 40 && Math.abs(player.y - t.y) < 40) {
        t.collected = true; player.fuel = Math.min(100, player.fuel + 40); score += 5;
      }
    });

    if (player.collisionTimer > 0) player.collisionTimer--;
    asteroids.forEach(a => {
        let dx = (player.x % worldWidth) - a.x; let dy = player.y - a.y;
        if (Math.sqrt(dx*dx + dy*dy) < 40 && player.collisionTimer === 0) { player.collisionTimer = 30; player.vy = 8; score = Math.max(0, score - 5); }
    });
    if (player.y > canvas.height) player.y = canvas.height;
    if (spaceDistance > 5000 && Math.abs((player.x % worldWidth) - 1000) < 100) { resetEarth(); score += 100; }
  }
  cameraX = player.x - canvas.width / 2;
}

function draw() {
  if (gameState === "START") return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (gameState === "EARTH") {
    ctx.fillStyle = "#020a2a"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    const offsets = [-worldWidth, 0, worldWidth];
    offsets.forEach(off => {
      ctx.font = "80px serif"; ctx.fillText("üåñ", 200 + off - cameraX * 0.2, 120);
      stars.forEach(s => { ctx.font = "16px serif"; ctx.fillText(s.emoji, s.x + off - cameraX * 0.1, s.y); });
      ctx.fillStyle = "#2f7d32"; ctx.fillRect(off - cameraX, treeY, worldWidth, GRASS_H);
      ctx.fillStyle = "#333"; ctx.fillRect(off - cameraX, groundY + 20, worldWidth, ROAD_H);
      trees.forEach((t, i) => { ctx.font = "70px serif"; ctx.fillText("üå≤", (i*150) + off - cameraX, treeY + 30); });
      buildings.forEach(b => { ctx.font = "100px serif"; ctx.fillText(b.emoji, b.x + off - cameraX, treeY + 30); });
      farm.forEach(f => { if (!f.abducted) { ctx.font = f.h + "px serif"; ctx.fillText(f.emoji, f.x + off - cameraX, f.y); } });
    });

    if (ufo.size > 0) {
      if (ufo.beamAlpha > 0 && ufo.state === "ABDUCTING") {
        ctx.save(); // Isolation block
        const grad = ctx.createLinearGradient(0, ufo.y, 0, groundY + 100);
        grad.addColorStop(0, `rgba(0, 255, 255, ${ufo.beamAlpha})`);
        grad.addColorStop(1, "rgba(0, 255, 255, 0)");
        ctx.fillStyle = grad; ctx.beginPath();
        ctx.moveTo(ufo.x - cameraX + ufo.size/2, ufo.y + ufo.size/2);
        ctx.lineTo(ufo.x - cameraX - 60, groundY + 100);
        ctx.lineTo(ufo.x - cameraX + ufo.size + 60, groundY + 100);
        ctx.fill();
        ctx.restore(); // Restore global state
      }
      ctx.font = ufo.size + "px serif";
      ctx.fillText("üõ∏", ufo.x - cameraX, ufo.y + (ufo.size/2));
    }
  } else {
    // SPACE
    ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    for(let i=-1; i<2; i++) {
        let off = i * worldWidth;
        ctx.font = "120px serif"; ctx.fillText("ü™ê", 500 + off - cameraX * 0.3, 200);
        ctx.font = "60px serif"; ctx.fillText("üåç", 2500 + off - cameraX * 0.4, 400);
        stars.forEach(s => { ctx.font = "16px serif"; ctx.fillText(s.emoji, s.x + off - cameraX, s.y); });
        asteroids.forEach(a => { ctx.font = "40px serif"; ctx.fillText(a.emoji, a.x + off - cameraX, a.y); });
        fuelTanks.forEach(f => { if(!f.collected) { ctx.font = "30px serif"; ctx.fillText("üîã", f.x + off - cameraX, f.y); } });
    }
    if (spaceDistance > 4000) { ctx.font = "120px serif"; ctx.fillText("üåÄ", 1000 - (cameraX % worldWidth), canvas.height/2); }
  }

  // PLAYER (Drawn after beam to ensure no ghosting)
  if (selectedChar.type === 'png') {
    const img = (player.dir === "right") ? imgRight : imgLeft;
    if (img.complete) ctx.drawImage(img, player.x - cameraX - 30, player.y - 60, 60, 60);
  } else {
    ctx.font = "50px serif";
    ctx.fillText((player.dir === "right") ? selectedChar.right : selectedChar.left, player.x - cameraX - 25, player.y);
  }

  if (player.collisionTimer > 0) { ctx.font = "50px serif"; ctx.fillText("üí•", player.x - cameraX - 25, player.y - 30); }
  else if (gameState === "SPACE" && keys.jump && player.fuel > 0) { ctx.font = "30px serif"; ctx.fillText("üî•", player.x - cameraX - 15, player.y + 10); }
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>

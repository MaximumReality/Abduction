<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Maximum Reality ‚Äì The Infinite Loop</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html, body { margin: 0; padding: 0; overflow: hidden; background: #000; font-family: sans-serif; }
  #controls { position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 100; padding: 10px; }
  button { font-size: 28px; padding: 12px 20px; border-radius: 12px; border: none; background: rgba(255,255,255,0.15); color: #fff; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.3); touch-action: manipulation; width: 75px; height: 65px; }
  button:active { background: rgba(0, 255, 255, 0.4); }
</style>
</head>
<body>

<canvas id="game"></canvas>

<div id="controls">
  <button id="left">‚¨ÖÔ∏è</button>
  <button id="jump">‚¨ÜÔ∏è</button>
  <button id="right">‚û°Ô∏è</button>
</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let gameState = "EARTH"; 
let cameraX = 0;
let spaceDistance = 0; 
const worldWidth = 8000;

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resize();
window.addEventListener("resize", resize);

/* PHYSICS & WORLD */
const ROAD_H = 120; 
const GRASS_H = 140;
let groundY = canvas.height - ROAD_H - 50; 
let treeY = canvas.height - ROAD_H - GRASS_H;

/* PLAYER */
const player = {
  x: 300, y: groundY, vy: 0,
  jumping: false, dir: "right", speed: 7,
  isBeingAbducted: false
};
const imgRight = new Image(); imgRight.src = "IMG_2161.png";
const imgLeft = new Image(); imgLeft.src = "IMG_2162.png";

/* UFO */
const ufo = {
  state: "WAITING", 
  x: 0, y: 100, size: 0,
  targetX: 4465, timer: 0, beamAlpha: 0
};

/* OBJECTS */
const stars = Array.from({length: 200}, () => ({ x: Math.random() * worldWidth, y: Math.random() * 400, emoji: ["‚≠ê", "‚ú®"][Math.floor(Math.random()*2)] }));
const asteroids = Array.from({length: 40}, () => ({ x: Math.random() * 10000, y: Math.random() * canvas.height, emoji: "ü™®" }));
const buildings = Array.from({length: 15}, (_, i) => ({ x: i * 350, emoji: ["üè¢", "üè¨", "üè≠"][i % 5] }));

// Restored Trees - Anchored to the grass/sky line
const trees = Array.from({length: 60}, (_, i) => ({
  x: i * 140,
  y: treeY + 30, // Seated on the horizon
  size: 70
}));

const farm = [
  { emoji: "üè†", x: 4450, y: treeY + 10, h: 100 },
  { emoji: "üêÑ", x: 4465, y: treeY + 100, h: 50, abducted: false }
];

/* INPUT */
let keys = { left: false, right: false, jump: false };
function bind(id, k) {
  const btn = document.getElementById(id);
  const start = (e) => { e.preventDefault(); keys[k] = true; };
  const end = (e) => { e.preventDefault(); keys[k] = false; };
  btn.addEventListener("touchstart", start); btn.addEventListener("touchend", end);
  btn.addEventListener("mousedown", start); btn.addEventListener("mouseup", end);
}
bind("left", "left"); bind("right", "right"); bind("jump", "jump");

function resetEarth() {
  gameState = "EARTH";
  player.isBeingAbducted = false;
  player.y = groundY;
  player.vy = 0;
  player.x = 300;
  spaceDistance = 0;
  ufo.state = "WAITING";
  ufo.timer = 0;
  ufo.beamAlpha = 0;
  const cow = farm.find(f => f.emoji === "üêÑ");
  cow.y = treeY + 100;
  cow.abducted = false;
}

function update() {
  const cow = farm.find(f => f.emoji === "üêÑ");

  if (gameState === "EARTH") {
    if (keys.left && !player.isBeingAbducted) { player.x -= player.speed; player.dir = "left"; }
    if (keys.right && !player.isBeingAbducted) { player.x += player.speed; player.dir = "right"; }
    
    if (player.isBeingAbducted) {
      player.x += (ufo.x + (ufo.size/2) - player.x - 30) * 0.1;
      player.y -= 3;
      if (player.y < ufo.y + 20) {
          gameState = "SPACE";
          player.vy = 0;
          player.x = 200;
      }
    } else {
      if (keys.jump && !player.jumping) { player.vy = -18; player.jumping = true; }
      player.vy += 0.8;
      player.y += player.vy;
      if (player.y > groundY) { player.y = groundY; player.vy = 0; player.jumping = false; }
    }

    ufo.timer++;
    switch (ufo.state) {
      case "WAITING":
        if (ufo.timer > 300) { ufo.state = "INBOUND"; ufo.x = player.x + 1200; ufo.size = 50; ufo.beamAlpha = 0; }
        break;
      case "INBOUND":
        ufo.x -= 9; ufo.size = Math.min(115, ufo.size + 1);
        ufo.y = 100 + Math.sin(ufo.timer / 15) * 15;
        if (ufo.x <= ufo.targetX) ufo.state = "ABDUCTING";
        break;
      case "ABDUCTING":
        // Beam only appears in this state
        ufo.beamAlpha = Math.min(0.4, ufo.beamAlpha + 0.02);
        if (Math.abs(player.x - (ufo.x + ufo.size/2)) < 65 && !player.jumping) player.isBeingAbducted = true;
        if (!cow.abducted) {
          cow.y -= 2;
          if (cow.y < ufo.y + 40) { cow.abducted = true; ufo.timer = 0; }
        } else if (ufo.timer > 120 && !player.isBeingAbducted) ufo.state = "OUTBOUND";
        break;
      case "OUTBOUND":
        ufo.beamAlpha = Math.max(0, ufo.beamAlpha - 0.05); // Fade beam out
        ufo.x -= 12; ufo.size -= 1;
        if (ufo.size <= 0) { ufo.state = "WAITING"; ufo.timer = 0; cow.y = treeY + 100; cow.abducted = false; }
        break;
    }
  } else {
    spaceDistance += player.speed;
    if (keys.left) { player.x -= player.speed; player.dir = "left"; }
    if (keys.right) { player.x += player.speed; player.dir = "right"; }
    if (keys.jump) player.vy -= 1.0; 
    player.vy += 0.3; 
    player.y += player.vy;
    player.vy *= 0.96;
    if (player.y < 0) { player.y = 0; player.vy = 0; }
    if (player.y > canvas.height) { player.y = canvas.height; player.vy = 0; }
    if (spaceDistance > 5000 && Math.abs(player.x - 4000) < 100) resetEarth();
  }
  cameraX = player.x - canvas.width / 2;
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  if (gameState === "EARTH") {
    ctx.fillStyle = "#020a2a"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    stars.forEach(s => { ctx.font = "16px serif"; ctx.fillText(s.emoji, s.x - cameraX * 0.1, s.y); });
    
    // Ground layers
    ctx.fillStyle = "#2f7d32"; ctx.fillRect(-cameraX, treeY, worldWidth, GRASS_H);
    ctx.fillStyle = "#333"; ctx.fillRect(-cameraX, groundY + 20, worldWidth, ROAD_H);

    // DRAW TREES FIRST (Background)
    trees.forEach(t => {
      ctx.font = t.size + "px serif";
      ctx.fillText("üå≤", t.x - cameraX, t.y);
    });

    // Buildings and Farm (Middle ground)
    ctx.font = "100px serif";
    buildings.forEach(b => ctx.fillText(b.emoji, b.x - cameraX, treeY + 30));
    farm.forEach(f => { if (!f.abducted) { ctx.font = f.h + "px serif"; ctx.fillText(f.emoji, f.x - cameraX, f.y); }});

    // UFO Logic
    if (ufo.size > 0) {
      // Beam only draws when alpha > 0 and NOT in inbound fly-in
      if (ufo.beamAlpha > 0) {
        const grad = ctx.createLinearGradient(0, ufo.y, 0, groundY + 100);
        grad.addColorStop(0, `rgba(0, 255, 255, ${ufo.beamAlpha})`);
        grad.addColorStop(1, "rgba(0, 255, 255, 0)");
        ctx.fillStyle = grad; ctx.beginPath();
        ctx.moveTo(ufo.x - cameraX + ufo.size/2, ufo.y + ufo.size/2);
        ctx.lineTo(ufo.x - cameraX - 60, groundY + 100);
        ctx.lineTo(ufo.x - cameraX + ufo.size + 60, groundY + 100);
        ctx.fill();
      }
      ctx.font = ufo.size + "px serif";
      ctx.fillText("üõ∏", ufo.x - cameraX, ufo.y + (ufo.size/2));
    }
  } else {
    // SPACE
    ctx.fillStyle = "#000"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    stars.forEach(s => { ctx.font = "16px serif"; ctx.fillText(s.emoji, (s.x - cameraX * 0.5) % canvas.width, s.y); });
    asteroids.forEach(a => { ctx.font = "40px serif"; ctx.fillText(a.emoji, (a.x - cameraX) % 10000, a.y); });
    
    if (spaceDistance > 4000) {
        ctx.font = "120px serif";
        ctx.fillText("üåÄ", 4000 - cameraX, canvas.height/2);
        ctx.font = "20px sans-serif"; ctx.fillStyle = "#0ff";
        ctx.fillText("PORTAL DETECTED! FLY INTO THE VORTEX!", 4000 - cameraX - 100, canvas.height/2 + 100);
    }
    
    ctx.fillStyle = "#0f0"; ctx.font = "bold 20px sans-serif";
    ctx.fillText("DIST TO PORTAL: " + Math.max(0, Math.floor(5000 - spaceDistance)) + "m", 20, 50);
  }

  // PLAYER DRAWING & FLIP (Foreground)
  const currentImg = (player.dir === "right") ? imgRight : imgLeft;
  if (currentImg.complete) {
    ctx.drawImage(currentImg, player.x - cameraX - 30, player.y - 60, 60, 60);
  } else {
    ctx.font = "50px serif";
    ctx.fillText(player.dir === "right" ? "üë®" : "üë®‚Äç", player.x - cameraX - 25, player.y);
  }

  if (gameState === "SPACE" && keys.jump) {
      ctx.font = "30px serif"; ctx.fillText("üî•", player.x - cameraX - 15, player.y + 10);
  }
}

function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
